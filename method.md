# 方法论总纲：基于可微安全层的敏捷飞行体系

## 1. 愿景与研究目标
- **核心任务**：构建一个单无人机在高度复杂、动态环境中执行任务时，兼顾 _绝对安全约束_ 与 _高效路径规划_ 的端到端学习系统。
- **理论基石**：
  - *GCBF+*：提供图结构控制障碍函数（Graph Control Barrier Function）作为形式化安全证据。
  - *Back to Newton’s Laws*（DiffPhysDrone）：以可微分物理仿真 + BPTT 直接优化视觉-控制策略，实现高性能敏捷飞行。
- **应用场景**：森林/仓储/城市峡谷等密集障碍场景，具备零通讯、低算力部署的能力。

## 2. 设计原则
1. **模型一致性**：安全层、策略与物理引擎采用统一的动力学假设（点质量 + 推力迟滞 + 气动阻力），保证 CBF 约束与实际执行一致。
2. **纯 JAX 实现**：所有组件（感知、策略、QP、安全回退、渲染、物理）必须是纯函数，可被 `jit`、`vmap`、`grad`、`lax.scan` 组合。
3. **可微安全优先**：安全层将梯度主动返回给策略网络，同时提供详尽的诊断信息以支持在线回退与训练自适应。
4. **课程式训练**：通过阶段化噪声、扰动和教师蒸馏，先稳定效率策略，再逐步打开安全约束与鲁棒性。
5. **指标守门**：训练过程对成功率、最大违约、跨平台安全求解器降级率设定硬阈值；违反即回滚或终止，避免积累虚假“成功”。

## 3. 系统总体架构
```
LiDAR / 深度图  ─┬─> 点云图构建 (GraphConfig) ─> GNN-CBF ─┐
机体状态        │                                   │
任务指令 ──────┼───────────────────────────────┬──> 策略网络 (MLP/GRU) ─┐
外部扰动        │                                   │                       │
                │                                   └──> CBF 值/梯度/海森 ─┤
                └───────────── 物理状态观测 ────────┘                       │
                                                                            ▼
                                             跨平台可微 QP + 多级回退逻辑 ──> 安全控制 u_safe
                                                                            │
                                                                            ▼
                             JAX 原生可微物理引擎（推力缓冲/阻力/控制频率抖动）──> 下一状态
                                                                            │
                                          轨迹记录 (positions, velocities, cbf, violations, vids)
                                                                            │
                                                                            ▼
                                       多目标损失（效率 + 安全 + 蒸馏 + 正则） → Optax 更新
```

## 4. 模块与职责

### 4.1 感知与图构建（`core/perception.py`）
- **输入**：机体状态 `DroneState`、LiDAR/深度点云、课程扰动噪声。
- **图生成**：实现 JAX 原生 `pointcloud_to_graph`：
  - 以半径约束 + `jax.lax.top_k` 构建自中心图。
  - 节点特征包含位置、速度、加速度、点云相对向量等。
  - 关键：保持时间连续性，必要时对点云做排序/滤波以降低跳变。
- **GNN 结构**：复用 GCBF+ 的注意力消息传递，但输出 _CBF 值、梯度、Hessian_：
  - 使用 `jax.grad` + `jax.jacfwd` 对位置求导。
  - 结果必须显式检查 `NaN/Inf`，发现异常立即落回解析 CBF 并记录日志。
- **数据增强**：内置点云抖动、遮挡模拟、稠密/稀疏切换，保证 CBF 网络在噪声环境下仍稳定。

### 4.2 策略网络（`core/policy.py`）
- 结构：Flax MLP 或 GRU（依据任务复杂度选择）。
- 输入：机体姿态、速度、目标偏差、CBF 值、任务 ID 等。
- 输出：名义控制 `u_nom`（世界系加速度）。
- 训练期间支持：
  - **教师蒸馏**：从效率阶段或 DiffPhys 基线策略引导。
  - **动作幅度裁剪**：保持与安全层、物理引擎统一的加速度上限。

### 4.3 可微安全层（`core/safety.py`）
- 采用自研的跨平台安全求解器求解 `(u - u_nom)^2 + ρδ^2`，流程如下：
  1. **解析主动集解算**：针对 3 维控制 + 1 维松弛的固定结构，枚举活跃约束获得闭式解；
  2. **OSQP 兜底**：若解析解不满足约束或数值不稳定，调用 OSQP 再求解一次；
  3. **紧急制动**：连续失败则执行反向加速度 + 垂直上升的安全动作，并追加惩罚。
  三个分支共享一套 `jax.custom_vjp` 定义，保证梯度路径与策略训练一致。
- 约束形式：二阶 CBF 条件 `L_f^2 h + α_1 L_f h + α_0 h + L_g L_f h · u + δ ≥ 0` + 控制盒约束 + 松弛区间 `[0, δ_max]`。
- **梯度管理**：对解析/OSQP 输出统一封装 VJP，控制梯度幅度并在异常时自动降级；对 CBF 的梯度与 Hessian 采取幅值裁剪和 `stop_gradient` 门限。
- **多级回退**：
  1. 解析成功 → 直接采用；
  2. 解析失败 → 切换 OSQP，并记录 `solver_mode=osqp`；
  3. OSQP 失败 → 启动紧急制动、增加松弛惩罚、缩短动作上限。
- **诊断输出**：`constraint_violation`、`relaxation`、`used_relaxation`、`solver_mode`（analytic/osqp/emergency）、`solver_switch_count`、`fail_reason`。

### 4.4 可微物理引擎（`core/physics.py` + 渲染模块）
- 目标：匹配 DiffPhysDrone 关键特性，同时保持纯 JAX。
- **动力学**：
  - 点质量模型 + 重力补偿。
  - 推力迟滞（IIR 滤波）、推力饱和。
  - 空气阻力、侧向拖曳。
  - 可配置控制频率抖动、执行延迟。
- **渲染**：
  - JAX 实现的深度投影或体素渲染（首期可用稀疏点云近似）。
  - 在反向传播时保持连续导数，确保视觉损失可微。
- **时间梯度衰减**：实现 `g_decay(x, α)`，默认 `α = 0.92`，支持阶段性调度。
- **批量环境**：`vmap` 支持多环境并行，用于课程噪声与 domain randomization。

### 4.5 BPTT 循环（`core/loop.py`）
- `jax.lax.scan` 串联：
  1. 点云扰动与噪声采样。
  2. CBF 评估（网络 + 解析混合）。
  3. 策略前向、可微安全滤波。
  4. 物理推进与梯度衰减。
  5. 轨迹记录（位置、速度、控制、CBF、违约、松弛）。
- `scan` 输出提供给损失函数、评价器以及可选视频生成。
- 关键：循环体保持纯函数；所有随机性通过 `rng` 显式传递。

## 5. 训练与优化策略

### 5.1 两阶段 + 课程式流程
1. **效率阶段**（无安全层）：
   - 目标：复制 DiffPhysDrone 的高效飞行策略。
   - 数据：大量随机目标 + 障碍随机化。
   - 损失：目标达成、速度跟踪、控制能耗、平滑度、悬停、时间加权。
   - 产物：高成功率的名义策略参数 (`policy_eff`)。
2. **安全阶段**：
   - 起点：加载 `policy_eff`，逐步开启安全层与 CBF 网络。
   - **阶段 1**：解析 CBF + 零噪声，校准安全求解器阈值（解析/OSQP 切换），成功率 ≥ 0.9。
   - **阶段 2**：解析 + 神经混合，噪声/扰动递增，蒸馏保持性能。
   - **阶段 3**：全神经 CBF + 全噪声课程，加入 adversarial curriculum（ACC）。

### 5.2 损失函数组合
- **效率损失**（DiffPhys 核心）：
  - 各向异性目标距离、速度对齐、控制能耗、平滑度、悬停、时间衰减。
- **安全损失**（GCBF+ 核心）：
  - 安全集正损失（安全区域要求 `h ≥ margin`）。
  - 不安全样本负惩罚（危险区域要求 `h ≤ -margin`）。
  - 导数约束损失 `ḣ + α h`。
  - 解析与神经 CBF 差异 L2 正则。
  - 安全求解器松弛与约束违约罚项（含自适应权重）。
- **鲁棒性项**：
  - 安全求解器降级惩罚、紧急制动触发惩罚。
  - 梯度 Lipschitz 正则（控制 CBF 输出剧烈震荡）。
  - 时间梯度衰减调度：初始弱，稳定后增强（防止梯度爆炸）。
- **蒸馏**（可选）：
  - 策略蒸馏：对齐 `policy_eff` 行为。
  - CBF 蒸馏：解析 CBF 提供标签，强化神经 CBF 学习。

### 5.3 优化器与调度
- Optax `adamw` + 余弦退火 + 梯度裁剪（全局范数）。
- `gradient_accumulation` 支持较大 batch。
- 超参通过 `ml_collections`/`omegaconf` 管理，训练启动时固化到 `outputs/<run>/config.json`。

## 6. 安全与稳定性保障
1. **安全求解器健康监控**：
   - 统计解析/OSQP 切换率、紧急制动率、松弛使用率；超过阈值立即停训并记录。
   - 自动降级策略（调高松弛、增大安全 margin、降低控制幅度）。
2. **CBF 质量控制**：
   - 所有 `jnp.nan_to_num` 替换为显式异常记录。
   - 输出幅值裁剪 + Lipschitz 正则；必要时软强制 `h ∈ [-H_max, H_max]`。
   - 预训练数据覆盖贴边、狭缝、动态障碍、感知噪声。
3. **数据一致性**：
   - 物理模型参数与 CBF 约束严格一致（dt、max_acc、drag、delay）。
   - 渲染管线与 CBF 输入共享点云/深度信息，确保梯度路径同步。
4. **指标守门**：
   - `tools/check_regression.py` 默认阈值：`success_rate ≥ 0.9`、`max_violation ≤ 20`、`relax_mean ≤ 0.05`。
   - 任一指标不达标即标记失败并生成报警。
5. **回退体系**：
   - 紧急制动策略 = 反向加速度 + 垂直上升 + 速度裁剪。
   - 回退次数进入日志与惩罚，防止策略依赖“紧急刹车”。

## 7. 数据生成与预训练
- **CBF 数据集**：
  - 使用解析 CBF + 蒙特卡洛采样生成 `(state, point_cloud, h_analytic, ∇h, ∇²h)`。
  - 引入噪声、动态障碍、对抗场景（小间隙、移动障碍）。
  - 数据分批存储 `baseline_cbf.pkl`，支持增量训练。
- **效率策略初值**：
  - 通过 DiffPhys 风格的大规模仿真 + 课程建立高性能策略。
- **教师模型**：
  - 将效率策略权重作为安全阶段蒸馏教师。
  - 可选：引入简单 PID/CBF 控制器作为监督。

## 8. 实验与评估流程
1. **离线评估**（每 `N` episode）：
   - 噪声等级 0 / 0.02 / 0.05，`16~64` 次 rollout。
   - 指标：到达率、最小 CBF、最大违约、松弛率、求解器降级率、能耗。
2. **鲁棒性评估**：
   - 随机点云、传感遮挡、动态障碍、控制频率抖动。
   - 统计成功率和安全指标。
3. **可视化**：
   - 轨迹、控制、CBF、约束曲线。
   - 失败案例回放（生成 GIF/视频）。
4. **报告生成**：
   - `tools/collect_metrics.py + plot_metrics.py + report_generate.py` 自动汇总。
   - `artifacts/` 存储 PDF、JSON 汇总与基线对比。

## 9. 实施里程碑
| 阶段 | 目标 | 关键输出 |
|------|------|----------|
| M0  | 架构搭建 | 完成 JAX 版本的感知/策略/物理/BPTT 基线，效率阶段成功率 ≥ 0.9 |
| M1  | 安全基线 | 解析 CBF + 跨平台安全求解器稳定收敛，成功率 ≥ 0.9，违约 < 20 |
| M2  | 神经 CBF | 神经/解析混合达到同等指标，解析⇄OSQP 切换率 < 1% |
| M3  | 噪声鲁棒 | 全噪声课程稳定训练，鲁棒评估成功率 ≥ 0.8 |
| M4  | 实验扩展 | 引入渲染、并行环境与随机化；准备硬件在环验证 |
| M5  | 工程交付 | 完成文档、脚本、模型打包，生成最终技术报告 |

## 10. 风险与缓解
- **CBF 学不出有效屏障**：加强预训练覆盖、引入梯度/Hessian 监督、增加输出正则。
- **QP 数值不稳定**：优化初值、调节松弛权重、加入回退与日志监控。
- **物理不匹配真实环境**：补充推力迟滞、拖滞、风扰等模型；后期进行硬件在环调参。
- **训练振荡**：使用时间梯度衰减、自适应学习率、梯度裁剪；过高违约触发课程回退。
- **数据资产管理失控**：通过 manifest 与配置快照标记所有实验；定期清理无效结果。

## 11. 依赖与工具链
- **核心库**：`jax/jaxlib`、`flax`、`optax`、`jraph`、`ml_collections`、`omegaconf`、`numpy`、`scipy`、`osqp`。
- **可选扩展**：`chex`（测试）、`wandb`（追踪）、`trimesh/pyrender`（高级渲染）、`tensorboard`（日志）。
- **项目脚本**：
  - `train_safe_policy.py`：训练入口，统一加载配置、初始化模块、管理课程与评估。
  - `tools/pretrain_cbf.py`：神经 CBF 预训练（支持解析/OSQP 双标签与 look-ahead 采样）。
  - `tools/run_safety_suite.py` / `run_distill_suite.py`：批量实验。
  - `tools/check_regression.py`：指标守门。
  - `tools/stage_summary.py` / `report_generate.py`：自动化报告。

## 12. 总结
本方法论以形式化安全保障为先导，将 GCBF+ 的图结构安全证据与 DiffPhysDrone 的可微分物理训练深度融合，形成一个 **纯 JAX、端到端可微、可验证** 的敏捷飞行系统。通过精细的课程设计、严格的安全监控和系统级优化，我们可以在保证安全约束不被突破的同时，逼近期望的高效机动表现，为复杂环境中的自主飞行提供坚实的理论与工程基础。随后阶段将围绕上述里程碑逐步推进，实现从仿真到现实的无缝迁移。
